# Maintainer: Drew DeVault <sir@cmpwn.com>
pkgname=hare
pkgver="0_git20220607"
_commit=de82b496b581e60f9de25c414b7c05bd7cdbdf44
pkgrel=0
pkgdesc="The Hare systems programming language"
url="https://harelang.org"
# riscv64: FTBFS: Abort: ./os/exec/cmd.ha:79:1: execution reached unreachable code (compiler bug)
# Caused by qemu-user, see https://gitlab.com/qemu-project/qemu/-/issues/1007
arch="x86_64 aarch64"
license="MPL-2.0 AND GPL-3.0-only"
depends="qbe harec binutils"
makedepends="scdoc"
subpackages="$pkgname-doc"
source="
	$pkgname-$_commit.tar.gz::https://git.sr.ht/~sircmpwn/hare/archive/$_commit.tar.gz
	config.aarch64.mk
	config.riscv64.mk
	config.x86_64.mk
"
builddir="$srcdir/$pkgname-$_commit"

build() {
	cp "$srcdir"/config.$CARCH.mk ./config.mk
	export VERSION="dev+$(echo "$_commit" | cut -c-7)"
	export LOCALVER=alpine
	make -j1 # XXX: parallel build driver builds are broken
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
}

sha512sums="
fd291dcf0484193b6aff568a8941e27ca2e7b70a13f52730f14fc7c05a7194c155f4823cbd7edb52d3954a4bd5242634de4cd99afd3078961b1203855dc9235e  hare-de82b496b581e60f9de25c414b7c05bd7cdbdf44.tar.gz
6f6abab010af80dea66b58e6a0daa050f4bd3f2ed76a7e714d227959dde6761ec6a0be826447d9dae647268f93cbb6b4b8b962363daf02e5fab8925ec08da43a  config.aarch64.mk
eb77cd9f2d2a1a3dccbb281f6d32da5da77b60a1287dfb3722d53069a30851146ff7bbff8c1dc24b0de2a829b324a4a28b47bbf78110bac8956048229497c65b  config.riscv64.mk
d12caa063af963f188930812d37efe3bf00d7535369699ff2010dfcdde06e6c87d9773c503ce8a01b726e8ec0ab416c4403de323d882a57b9f14a308eb635f9a  config.x86_64.mk
"
